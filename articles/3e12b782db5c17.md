---
title: "TypeScriptã®å‹å†å¸°å‘¼ã³å‡ºã—ã‚’ä½¿ã£ã¦ã€graphql-codegenã§è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå‹ã‹ã‚‰éƒ¨åˆ†çš„ãªå‹ã‚’å–ã‚Šå‡ºã™"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [typescript]
published: true
---

## è¦ã™ã‚‹ã«...
ã“ã†ã„ã†å‹ã‹ã‚‰
```ts
type User_Anime_ListQuery = {
  __typename?: "Query";
  MediaListCollection?: {
    __typename?: "MediaListCollection";
    lists?: Array<{
      __typename?: "MediaListGroup";
      entries?: Array<{
        __typename?: "MediaList";
        media?: {
          __typename?: "Media";
          id: number;
          title?: {
            __typename?: "MediaTitle";
            native?: string | null;
            romaji?: string | null;
            english?: string | null;
          } | null;
          coverImage?: {
            __typename?: "MediaCoverImage";
            extraLarge?: string | null;
            large?: string | null;
          } | null;
        } | null;
      } | null> | null;
    } | null> | null;
  } | null;
};
```

ã“ã†ã„ã†å‹ã‚’éƒ¨åˆ†çš„ã«å–ã‚Šå‡ºã—ãŸã„
```ts
type Media = {
  __typename?: "Media";
  id: number;
  title?: {
    __typename?: "MediaTitle";
    native?: string | null;
    romaji?: string | null;
    english?: string | null;
  } | null;
  coverImage?: {
    __typename?: "MediaCoverImage";
    extraLarge?: string | null;
    large?: string | null;
  } | null;
};
```

## çµè«–
è‡ªä½œã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å‹ã‚’ä½¿ã†ã“ã¨ã§è§£æ±º
```ts
type extractTypeName<T, __typename> = T extends
  | {
      [key in string]?: infer U;
    }
  | Array<infer U>
  ? U extends { __typename?: __typename }
    ? U
    : extractTypeName<U, __typename>
  : never;

type Media = extractTypeName<User_Anime_ListQuery, "Media">;
```

## è§£èª¬
### çµŒç·¯
[AniList](https://anilist.co/home)ã¨ã„ã†è‡ªåˆ†ã®ã‚¢ãƒ‹ãƒ¡ãƒªã‚¹ãƒˆã‚’ä½œã‚‹ã“ã¨ãŒã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚Šã€
GraphQLã®APIãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
[Introduction | AniList APIv2 Docs](https://anilist.gitbook.io/anilist-apiv2-docs)

[Codegen with GraphQL, Typescript, and Apollo - GraphQL Tutor...](https://www.apollographql.com/tutorials/lift-off-part1/09-codegen)
`@graphql-codegen/cli`ã‚’ä½¿ã†ã“ã¨ã§GraphQLã‚¯ã‚¨ãƒªã®æˆ»ã‚Šå€¤ã®å‹ã‚’è‡ªå‹•ç”Ÿæˆå‡ºæ¥ã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã£ã¦ã„ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
GraphQLã®ã‚¯ã‚¨ãƒªã‹ã‚‰å‹ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã¨ã€
```ts
const USER_ANIME_LIST = gql(`
  query USER_ANIME_LIST($userName: String!) {
    MediaListCollection(userName: $userName, type: ANIME) {
      lists {
        entries {
          media {
            id
            title {
              native
              romaji
              english
            }
            coverImage {
              extraLarge
              large
            }
          }
        }
      }
    }
  }
`);
```

ä»¥ä¸‹ã®ã‚ˆã†ãªå‹ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚
```ts
export type User_Anime_ListQuery = {
  __typename?: "Query";
  MediaListCollection?: {
    __typename?: "MediaListCollection";
    lists?: Array<{
      __typename?: "MediaListGroup";
      entries?: Array<{
        __typename?: "MediaList";
        media?: {
          __typename?: "Media";
          id: number;
          title?: {
            __typename?: "MediaTitle";
            native?: string | null;
            romaji?: string | null;
            english?: string | null;
          } | null;
          coverImage?: {
            __typename?: "MediaCoverImage";
            extraLarge?: string | null;
            large?: string | null;
          } | null;
        } | null;
      } | null> | null;
    } | null> | null;
  } | null;
};
```

ã“ã‚Œã ã‘ã§ã‚‚ä¾¿åˆ©ãªã®ã§ã™ãŒã€ä¾‹ãˆã°å–å¾—ã—ãŸæƒ…å ±ã®ä¸­ã«ã¯é…åˆ—ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€
è¦ç´ ä¸€ã¤ä¸€ã¤ã«ã¤ã„ã¦å‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’ä½œã‚ŠãŸã„å ´åˆã€ä¸Šè¨˜`User_Anime_ListQuery`ã‹ã‚‰
`__typename?: "Media";`ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ã‚’éƒ¨åˆ†çš„ã«å–ã‚Šå‡ºã—ãŸããªã‚‹ã¨ã„ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

æ„šç›´ã«å–ã‚Šå‡ºã—ãŸã„å‹ã‚’ã‚³ãƒ”ãƒšã—ã¦åˆ©ç”¨ã—ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€ä¾‹ãˆã°GraphQLã®ã‚¯ã‚¨ãƒªã‚’å¤‰æ›´ã—ãŸå ´åˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹å‹ã‚‚å¤‰æ›´ã•ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ”ãƒšãŒå¤šã‘ã‚Œã°å¤šã„ã»ã©ä¿å®ˆãŒå¤§å¤‰ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€`User_Anime_ListQuery["MediaListCollection"]["lists"]` ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§éƒ¨åˆ†çš„ãªå‹ã‚’å–ã‚Šå‡ºã™ã“ã¨ã‚‚ä»Šå›ã«é–¢ã—ã¦ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒundefinedã‚„nullã‚’å–ã‚Šã†ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

ãã“ã§ä¸‹è¨˜ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å‹ã‚’å®šç¾©ã—ã¾ã™ã€‚
```ts
type extractTypeName<T, __typename> = T extends
  | {
      [key in string]?: infer U;
    }
  | Array<infer U>
  ? U extends { __typename?: __typename }
    ? U
    : extractTypeName<U, __typename>
  : never;
```

### åŸç†
å®Ÿã¯TypeScript 3.7ä»¥é™ã§ã¯å†å¸°å‘¼ã³å‡ºã—ã‚’ä½¿ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚
[Announcing TypeScript 3.7 - TypeScript](https://devblogs.microsoft.com/typescript/announcing-typescript-3-7/#(more)-recursive-type-aliases5)

ä¾‹ãˆã°ã€`__typename: "Media"` ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ã‚’å–ã‚Šå‡ºã™ã¨ã—ã¾ã™ã€‚
`infer`ã‚’ä½¿ã£ã¦éƒ¨åˆ†çš„ãªå‹ã‚’å–ã‚Šå‡ºã—ã¦å†å¸°çš„ã«ãƒã‚¹ãƒˆã•ã‚ŒãŸå‹ã‚’æ¢ç´¢ã—ã€
`__typename: "Media"` ã‚’æŒã¤éƒ¨åˆ†çš„ãªå‹ã‚’è¦‹ã¤ã‘ãŸã‚‰ãã‚Œã‚’æœ€å¾Œã«è¿”ã™ã€ã¨ã„ã†ã‚ˆã†ãªå®Ÿè£…ãŒ`extractTypeName`ã®è€ƒãˆæ–¹ã«ãªã‚Šã¾ã™ã€‚

å…·ä½“çš„ã«åˆ†è§£ã—ãªãŒã‚‰è¦‹ã¦ã„ãã¨ã€
ã¾ãšã¯`infer`ã‚’åˆ©ç”¨ã—ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ã‚‚ã—ãã¯é…åˆ—ã®å‹ã®å–ã‚Šå‡ºã—ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
```ts
type extractTypeName1<T> = T extends
  | {
      [key in string]?: infer U;
    }
  | Array<infer U>
  ? U
  : never
```
`User_Anime_ListQuery`ã¯ã‚ˆãè¦‹ã‚‹ã¨æ·±ããƒã‚¹ãƒˆã•ã‚ŒãŸæ§‹é€ ã®ä¸­ã®ä¸€éƒ¨åˆ†ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ã—ãã¯é…åˆ—ã§å‡ºæ¥ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚
ãã“ã§ã€`infer`ã‚’ç”¨ã„ã¦é…åˆ—ã®å€¤ã€ã‚‚ã—ãã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å€¤éƒ¨åˆ†ã‚’å–ã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€ä¸‹è¨˜ã®ã‚ˆã†ãªå‹ã«å¯¾ã—ã¦ç¾æ®µéšã®`extractTypeName1`ã‚’åˆ©ç”¨ã™ã‚‹ã¨
```ts
type User_Anime_ListQuery = {
  __typename?: "Query";
  MediaListCollection?: {
	__typename?: "MediaListCollection";
	lists?: Array...
		...çœç•¥
  } | null;
};

type test1 = extractTypeName1<User_Anime_ListQuery>
// ä¸‹è¨˜ã®ã‚ˆã†ãªunionå‹ãŒå–ã‚Šå‡ºã›ã‚‹
type part1 = "Query" | {
    __typename?: "MediaListCollection";
    lists?: Array...
		...çœç•¥
} | null
```
ä¸€æ®µéšãƒã‚¹ãƒˆãŒä¸‹ãŒã£ãŸå½¢ã®unionå‹ãŒå–å¾—ã§ãã¾ã™ã€‚

ã¨ã“ã‚ã§ã€ä¸‹è¨˜ã®ã‚ˆã†ãªunionå‹ã«å¯¾ã—ã¦`extractTypeName1`ã‚’é©ç”¨ã™ã‚‹ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
```ts
type hoge = extractTypeName1<"hoge" | { a: string } | null>
type hoge = string // ã“ã‚Œã¨åŒç¾©ã«ãªã‚‹
```
ä¸Šè¨˜ã®ã‚ˆã†ã«`string`ã®ã¿ãŒå–ã‚Šå‡ºã•ã‚Œã¾ã™ã€‚
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„é…åˆ—ã®ã‚µãƒ–ã‚¿ã‚¤ãƒ—ã§ã¯ãªã„`"hoge"`ã‚„`null`ã¯`never`ã‚’è¿”ã™ãŸã‚ã€unionã‹ã‚‰å–ã‚Šé™¤ã‹ã‚Œã¾ã™ã€‚

ãã“ã§`test1`å‹ã«å¯¾ã—ã¦ã€å†åº¦`extractTypeName1`ã‚’é©ç”¨ã™ã‚‹ã¨ã€
```ts
type test2 = extractTypeName1<test1>
// ä¸‹è¨˜ã®ã‚ˆã†ãªå‹ãŒå–ã‚Šå‡ºã›ã‚‹
type part2 =  "MediaListCollection" | ({
    __typename?: "MediaListGroup";
    entries?: Array<{
		...çœç•¥
    } | null> | null;
} | null)[] | null
```
æ®µã€…ã¨ãƒã‚¹ãƒˆãŒä¸‹ãŒã£ã¦ã„ãæ§˜å­ãŒã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚
`"Query"`ã‚„`null`ãªã©ã®å‹ã¯`T extends | { [key in string]?: infer U; } | Array<infer U>`ã®æ¡ä»¶åˆ¤å®šã§`never`ã¨ãªã‚Šunionã‹ã‚‰å–ã‚Šé™¤ã‹ã‚Œã‚‹ãŸã‚ã€ã“ã®ã‚ˆã†ã«éƒ½åˆã‚ˆãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹é…åˆ—å‹ã®ã¿ã‚’æ¢ç´¢ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

æ¬¡ã¯ã€Generic typeã®å†å¸°å‘¼ã³å‡ºã—ã¨çµ‚äº†æ¡ä»¶ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
```ts
type extractTypeName<T, __typename> = T extends
  | {
      [key in string]?: infer U;
    }
  | Array<infer U>
  ? U extends { __typename?: __typename }
    ? U
    : extractTypeName<U, __typename>
  : never;
```
æ–°ãŸã«`__typename`å¼•æ•°ãŒå¢—ãˆã¦ã„ã¾ã™ã€‚
ç›®çš„ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å†åº¦ `extractTypeName`ã‚’å‘¼ã³å‡ºã—ã€`U`ã‚’å¼•æ•°ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§å†å¸°æ¢ç´¢ã—ã¦ã„ã¾ã™ã€‚
å…ˆç¨‹`infer`ã§å–ã‚Šå‡ºã—ãŸå‹`U`ãŒ`{ __typename?: "Media" }` ãªã©ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤å‹ã§ã‚ã‚Œã°å†å¸°æ¢ç´¢ã‚’çµ‚äº†ã—ã¦è‰¯ã„ã®ã§ã€ãã®ã¾ã¾`U`ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚
