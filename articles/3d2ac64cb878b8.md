---
title: "Dockerã§å‹•ã„ã¦ã„ã‚‹ Next.js (App router)ã‚’ vscode ã§ãƒ‡ãƒãƒƒã‚°ã™ã‚‹"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nextjs, docker, vscode, debug]
published: false
---

## å•é¡Œ
Next.js 13ä»¥é™ã§ã€ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§Next.jsãŒèµ·å‹•ã§ããªã„æ—¨ãŒå ±å‘Šã•ã‚Œã¦ã„ãŸã€‚
```bash
NODE_OPTIONS='--inspect=0.0.0.0' next dev
```
https://github.com/vercel/next.js/issues/53127

ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦nextã®ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã§ããªã„ã€‚
```
%> npm run debug

> next_debug_test@0.1.0 debug
> NODE_OPTIONS='--inspect=0.0.0.0' next dev

Debugger listening on ws://0.0.0.0:9229/xxxxxxxxxxxxxxxxxxxxxxxxxxx
For help, see: https://nodejs.org/en/docs/inspector
/home/**your_path**/nodejs/20.6.1/bin/node:  must be 0 or in range 1024 to 65535.
```

Next.jsã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹å ´åˆã€ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ãŒä¸€èˆ¬çš„ã§ã€ã“ã®ã¨ãNext.jsã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã‚’å—ã‘ä»˜ã‘ã‚‹ã€‚
```bash
NODE_OPTIONS='--inspect' next dev
```
ãã®ãŸã‚ãƒ›ã‚¹ãƒˆç’°å¢ƒã§Next.jsã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã‚„Devcontainerã§ãƒ‡ãƒãƒƒã‚°ã™ã‚‹å ´åˆã¯å•é¡Œãªã„ã‚‚ã®ã®ã€Dockerä¸Šã§ã‚µãƒ¼ãƒãƒ¼ã‚’å‹•ã‹ã—ã¦ã„ã‚‹å ´åˆã€vscodeã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã§å‹•ã„ã¦ã„ã‚‹Next.jsã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã€‚

## è§£æ±ºç­–
1. `v14.3.0-canary.23`ä»¥é™ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Next.jsã‚’åˆ©ç”¨ã™ã‚‹
https://github.com/vercel/next.js/releases/tag/v14.3.0-canary.23
ä¸Šè¨˜ã®ãƒªãƒªãƒ¼ã‚¹ã§ã“ã®ãƒã‚°ãŒä¿®æ­£ã•ã‚ŒãŸã€‚
Next.js ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰ãˆã‚‹ã®ãŒå®¹æ˜“ãªäººã€æ–°ã—ããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã™ã‚‹æ–¹ã«ãŠã™ã™ã‚ã®æ–¹æ³•ã€‚
(ã“ã¡ã‚‰ã®æ–¹æ³•ã‚’æ¡ç”¨ã™ã‚‹å ´åˆã¯node_modulesã®æ›¸ãæ›ãˆã¯ä¸è¦ã€‚)

2. node_modulesã®ãƒã‚°ã®åŸå› ã¨ãªã£ã¦ã„ã‚‹å ´æ‰€ã‚’ç›´æ¥æ›¸ãæ›ãˆã‚‹
ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰çš„ãªè§£æ±ºç­–ã ãŒã€æ¥­å‹™ã§Next.jsã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆç­‰ã§ç°¡å˜ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®nextã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰ãˆã‚‰ã‚Œãªã„æ–¹ã«ãŠã™ã™ã‚ã€‚

### node_modules ã®æ›¸ãæ›ãˆ
â€»è§£æ±ºç­–ã®1ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ä¸è¦ã€‚
node_modulesãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒã‚°ã®è©²å½“ç®‡æ‰€ã‚’æ›¸ãæ›ãˆã‚‹
```bash
sed -Ei '/NODE_OPTIONS.*nodeDebugType.*/s//NODE_OPTIONS = `${NODE_OPTIONS} --${nodeDebugType}=0.0.0.0:9230`;/' node_modules/next/dist/cli/next-dev.js
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã€`node_modules/next/dist/cli/next-dev.js`ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ä¸‹è¨˜ã®è¡Œã‚’
```js
  NODE_OPTIONS = `${NODE_OPTIONS} --${nodeDebugType}=${(0, _utils.getDebugPort)() + 1}`;
```

ã“ã¡ã‚‰ã«æ›¸ãæ›ãˆã¦ã„ã‚‹ã€‚
```js
  NODE_OPTIONS = `${NODE_OPTIONS} --${nodeDebugType}=0.0.0.0:9230`;
```

### ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
ã“ã‚Œã§ã€`npm run debug`ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã§ãã‚‹ã€‚
```
%> npm run debug

> next_debug_test@0.1.0 debug
> NODE_OPTIONS='--inspect=0.0.0.0' next dev

Debugger listening on ws://0.0.0.0:9229/xxxxxxxxxxxxxxxxxxxxxx
For help, see: https://nodejs.org/en/docs/inspector
Debugger listening on ws://0.0.0.0:9230/xxxxxxxxxxxxxxxxxxxxxx
For help, see: https://nodejs.org/en/docs/inspector
   the --inspect option was detected, the Next.js router server should be inspected at port 0.
  â–² Next.js 14.2.3
  - Local:        http://localhost:3000

 âœ“ Starting...
 âœ“ Ready in 2.2s
```

â€»å®Ÿã¯ã€node_modulesã®æ›¸ãæ›ãˆã‚’é¸æŠã—ãŸå ´åˆã¯ã“ã“ã§ã®è¡¨ç¤ºã‚‚å°‘ã—ãƒã‚°ã£ã¦ã„ã‚‹ã€‚
`the --inspect option...` ä»¥é™ã®éƒ¨åˆ†ã§ã€ã©ã®ãƒãƒ¼ãƒˆã§ãƒ‡ãƒãƒƒã‚°ã‚’å—ã‘ä»˜ã‘ã‚‹ã‹ã€ã¨ã„ã†è¡¨ç¤ºã¯`14.3.0-canary.23`ãƒªãƒªãƒ¼ã‚¹ä»¥é™ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã•ã‚Œã¦ã„ã‚‹ã€‚
```
the --inspect option was detected, the Next.js router server should be inspected at 0.0.0.0:9230.
```

### docker-composeã®è¨­å®š

## å‚è€ƒ
https://github.com/vercel/next.js/pull/65006

ä»¥ä¸‹ã®ãƒªãƒªãƒ¼ã‚¹ã§ä¿®æ­£ã•ã‚ŒãŸã€‚
https://github.com/vercel/next.js/releases/tag/v14.3.0-canary.23
https://www.npmjs.com/package/next/v/14.3.0-canary.28
