# 3 月の目標
- AWS Cloud Quest クリア、感想記事執筆
- https://explore.skillbuilder.aws/learn/course/external/view/elearning/1361/Amazon-API-Gateway-for-Serverless-Applications-Japanese-
API Gateway for serverless
or
https://explore.skillbuilder.aws/learn/course/external/view/elearning/99/aws-lambda-foundations

- learn Next.js の学習後感想、記事執筆
- Next.js の以下公式ドキュメント読了
https://nextjs.org/docs/app/building-your-application/routing/loading-ui-and-streaming
streaming
https://nextjs.org/docs/app/building-your-application/routing/middleware
middleware
https://nextjs.org/docs/app/building-your-application/data-fetching
data-fetch * 3
https://nextjs.org/docs/app/building-your-application/rendering
rendering * 3
https://nextjs.org/docs/app/building-your-application/caching
caching
https://nextjs.org/docs/app/building-your-application/testing
testing * 2
https://nextjs.org/docs/app/building-your-application/authentication
authentication

- AOJ 10 問
- Otaku-GPaT のバックエンド最低限基本機能完成
- Otaku-GPaT のUI作成、リリース
- Terraform AWS のチュートリアル全部
- Terraform Cloud チュートリアル
- Terraform Scale DynamoDB チュートリアル

# 記録

テンプレ

## 3/
### leetcode
### AOJ
### 個人開発
### Terraform
### AWS
### Next.js

## 3/9
### AOJ
クイックソート

### 個人開発
BatchExecuteStatementCommand ではcountなどが使えない
```ts
{
  Statement: "SELECT query, tracks FROM SpotifySearchCache WHERE query=?",
  Parameters: ["Rakuen no Tsubasa", "dororo"],
  ConsistentRead: true,
},
```
不定数のorをつなげる条件指定を書く方法がわからない
今回はBatchGetCommandで用途を満たせているので、sqlは不要

まずキャッシュから検索し、SearchResult に変換
SearchResultに存在しないqueryのリストを作る
上記のリストは自分でspotifyに検索をかける

次回 spotify APIでプレイリスト作成
アニメリスト取得から画面表示までつなぎこみ

### Terraform
VCS githubとterraform cloudを連携
speculative plan で実際にapplyする前にインフラの変更をレビューしてくれる
githubのコメントに書き込んでくれる

VCSに接続する場合は cloud ブロックがいらなくなる
UIからインフラの削除ができる

### AWS
lambda関数
ハンドラとコンテキスト

理論偏重で実践がほぼゼロなので、あまり成長できている気がしない。

### Next.js
learn Next.js 復習記事

## 3/8
### AOJ
https://onlinejudge.u-aizu.ac.jp/status/users/DJ_wata/submissions/1/ALDS1_6_B/judge/8977824/C++14
partition分割
ある値を基準にそれより小さいグループ、大きいグループに分ける

### 個人開発
```ts
export function Click({ action }: { action: AsyncFunction }) {
# と書くか
export const Click: FC<{ action: AsyncFunction}> = ({ action }) =>{
```
Next.jsのドキュメントはfunctionを使うケースしかない。

BatchGetCommand でqueryを複数指定して項目を取得できることを確認

Click コンポーネントからサーバーアクションをリフトアップして
呼び出し元からサーバーアクションを指定可能にした

次はpartiQLをバッチ実行した際の挙動の確認

### Terraform
Policy as Code
Terraform Cloud で時間、月あたりのコストの計算が出来る
https://qiita.com/jerichon/items/7ec5b41ec3d20831149a
https://dev.classmethod.jp/articles/terraformcloud-sentinel-policy-sets/
ポリシー違反している場合はデプロイできないようにも出来る

https://developer.hashicorp.com/terraform/tutorials/cloud-get-started/policy-quickstart
次はここから

### AWS
イベントソース

データストア系
S3、DynamoDB, Cognitなどがなりうる

エンドポイント
API Gateway

ポーリングとは？
lambda側から、送信したいデータが無いか定期的に問い合わせる

デッドレターキュー
lambda宛先指定

コールドスタートとウォームスタート
最初にlambdaが実行される際はコールドスタートになる
連続で処理が発生した場合はウォームスタートで速いレスポンスを期待できる
最後のリクエストから長い時間がたつと、またコールドスタートが必要に

設定次第である程度のリソースをウォームスタートで保ち続けることができる

コンソールからのテストは全てコールドスタート

### Next.js
learn Next.js 復習記事

https://chromewebstore.google.com/detail/codetospan-for-translatio/ebnohmjaodacnofjhknnjjnchanjleng?utm_source=zenn&utm_medium=article&utm_campaign=how_to_fix_machine_translation
https://zenn.dev/dev_inui/articles/da2c282f7da040
google翻訳に掛けると、コードタグが翻訳でおかしくなってしまう
解消する拡張機能

## 3/7
### leetcode
外部キーを参照してテーブルを表示する
２列の値を利用してgroup by

### 個人開発

DynamoDBClientを使う
`@aws-sdk/lib-dynamodb` を使うことで、より簡単にDynamoDBにアクセスできる
https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-lib-dynamodb/Class/PutCommand/

PutCommand は同じprimary keyでputされた場合はあとで追加した値に更新してしまう

curlでAPIを叩いた時と、SpotifyのAPI example pageで
APIを叩いたときで結果が違う
example pageで取得した結果が欲しい

ACCESS TOKENが変わると、取得結果の順番が変わってしまう

node_moduleパッケージの改造をテストしたいとき
https://github.com/spotify/spotify-web-api-ts-sdk
例えば、これ
git clone してrootで`npm i`
scriptsにbuildのコマンドがあるので、
`npm run build`
これで`dist/cjs`, `dist/mjs` にコンパイルされる
src上のファイルをいじって、npm run build すればまたコンパイルされるので、そのファイルを利用してexample_nodeなどを動かせる

withClientCredentials で取得するaccess tokenではあまり
正確な検索結果が得られなさそう

https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-lib-dynamodb/Class/BatchWriteCommand/
BatchWriteCommandを使うことで大量データの書き込みができそう

https://docs.aws.amazon.com/ja_jp/sdk-for-javascript/v3/developer-guide/javascript_dynamodb_code_examples.html
項目のバッチを取得する 項目のバッチを書き込む
に使い方が載っている

SearchResults をインメモリで保持し、曲名またはアニメタイトルでTrackInfoを検索できるようにする
DynamoDBにキャッシュが存在しない場合はSpotifyAPIを叩いてキャッシュを作成する
BatchGetCommand でレコードがなかった時、どのようなレスポンスになるか確認する
対応レコードがなかったときは、SpotityAPIを叩いてキャッシュを作成し、
SearchResults の適切なキーに追加する

- 目標
  - ユーザー数100人
  - 収益50$
  - ポートフォリオとしての制作物ではなく、本当に自分がほしいと思えるサービス
  - 課金機能の作成、課金に応えうる十分なサービス提供
  - 一朝一夕では作れない作品
- 重要度測定
  - 100
- 自信
  - 50
- 問題
  - (1)利用規約の作成など、開発以外での雑務の発生
  - (2)セキュリティ
  - (3)APIの機能変更
  - (4)収益化に伴うメンテナンスの責任
  - (5)インフラのベストプラクティスがわからない
  - (6)難しい機能になればなるほど、困った時に聞ける人がいない
- 資料/理由/使用法
  - (1)
  - (2)
  - (3)
  - (4)
  - (5)
  - (6)

## 3/6
### leetcode
count(distinct ~~~) の使い方
update 文の中でもifは式として使える

### 個人開発
Spotify SDKでどんなデータがとれるか確認
検索結果をキャッシュするDynamoDBのデータ形式を決定

### Terraform
Terraform Cloud とは
stateやenv var の管理がセキュアに出来る

CLI-driven workflow
VCS-driven workflow
API driven workflow

CLI-driven では、local executionとremote execution　が選べる
remote executionでは、terraform cloudからプロビジョニングが実行され
localでは自分のマシンから。
環境変数を自分のマシンにだけ収めたい場合はローカル実行もあり？
複数人で共有するインフラなら、環境変数の共有が面倒なのでリモート実行が良さそう

### AWS
https://explore.skillbuilder.aws/learn/course/621/play/1727/aws-lambda-foundations-japanese
lambda foundations

lambdaはEC2のようにAuto Scalingを設定する必要がなく、自動でスケールする

S3からイベント駆動でlambdaを動かせる
S3からlambdaを呼び出すアクセス許可がIAMリソースポリシー
lambdaが他のサービスを呼び出す権限設定がIAM実行ロール

デフォルトではVPC内リソースにlambdaからアクセスできない
lambdaはAWSが所有するVPC内に存在している

### Next.js
Learn Next.js 復習記事

## 3/5
### AOJ
マージソートで再帰、分割統治法を学ぶ
https://onlinejudge.u-aizu.ac.jp/problems/ALDS1_5_B

### 個人開発
相変わらず、AWSのアプリケーションの適切な認証方法がわからない...
今はcredentialで多分認証できているが、アプリをデプロイした際には
別の設定が必要になりそう。使っているアクセストークンをそのまま環境変数で渡しても良いものか...?

権限を絞って認証情報を渡したいが、なにがベストプラクティスなのか。
ChatGPT曰く、必要な権限のみを持ったIAM roleを作成し、クレデンシャルを
環境変数に格納するのが良いとのこと。Docker環境でも同じことができる？

https://docs.aws.amazon.com/ja_jp/sdk-for-javascript/v3/developer-guide/javascript_dynamodb_code_examples.html
DynamoDB のSDKの例を元に、テーブル一覧取得とテーブル追加まで

下記コマンドでpackage.jsonを初期化可能
```
node init -y
```
`package.json`に `"type": "module"` を追加することで
EcmaScriptのモジュールとして認識してもらう

### Terraform
variable の default = ~~~ で変数の値を宣言できる
terraformコマンドはカレントディレクトリの.tfファイルを全て読み込む
拡張子が合ってれば名前はなんでもよし

https://developer.hashicorp.com/terraform/tutorials/configuration-language/variables
variableを使って設定に柔軟性をもたせる
main.tfは複数インフラで使いまわして、
変数で状況に合わせてインスタンスの数を調整したりなど、といった使い方ができそう

tfファイル内の、
terraform, provider, などはブロックと呼ぶ

output ブロック
apply したあとなどにインスタンスの情報をoutputする
これによって他のインフラとつなぎこみができたりする

terraform cloudを使うことで、tfstateを安全に管理し、
インフラの状態をチームメイトと共同管理できる

次回 Terraform cloudのアカウント作成

### AWS
AWS Skill Builder CloudQuest 感想まとめ記事

### Next.js
Learn Next.js 感想まとめ記事

## 3/4
### AOJ
マージソート、分割統治法
clang-format で AllowShortIfStatementsOnASingleLine を追加

### 個人開発
サーバー側で、ユーザー認証を通さずにAPIを叩いている例を確認
withClientCredentials を使うことでとりあえず検索だけは出来る

secretを読むのに、サーバー側でコードを実行させるのに苦戦

onClickみたいなイベントハンドラが必要なものは全部client component
apiルートのときは、イベントハンドラからAPI呼び出しができたはず
app router ではどうする？

下記の方法でいける。(hogeはserver側のアクション)
```ts
'use server'

import { SpotifyApi } from "@spotify/web-api-ts-sdk";

export async function hoge() {
  const api = SpotifyApi.withClientCredentials(
    process.env.NEXT_PUBLIC_SPOTIFY_CLIENT_ID!,
    process.env.SPOTIFY_CLIENT_SECRET!
  );

  const items = await api.search("The Beatles", ["artist"]);

  console.table(
    items.artists.items.map((item) => ({
      name: item.name,
      followers: item.followers.total,
      popularity: item.popularity,
    }))
  );
}
```

ポイントは、handleClick内でサーバーアクションを呼び出すこと。
```tsx
'use client'

import { Button } from "@/components/ui/button";
import { hoge } from "../spotify/searchSong";
// import { SpotifyApi } from "@spotify/web-api-ts-sdk";

export default function Page() {
  function handleClick() {
    hoge();
  }

  return (
    <>
      <Button onClick={handleClick}>log</Button>
    </>
  );
}
```

onClickイベントの引数として直接呼び出すと、ブラウザ側で実行されてしまう
```tsx
'use client'

import { Button } from "@/components/ui/button";
import { hoge } from "../spotify/searchSong";
// import { SpotifyApi } from "@spotify/web-api-ts-sdk";

export default function Page() {
  return (
    <>
      <Button onClick={hoge}>log</Button>
    </>
  );
}
```

### Terraform
known after apply →作ってみないとわからない値
terraform.tfstate
AWSのインスタンスIDなど、AWSのAPIから返ってきた情報が逐一格納される
これのおかげでインスタンスの操作が出来る（削除など）
センシティブな情報が入る可能性がある野江、セキュアに格納する必要がある
プロダクション環境ではTerraform Cloudを使うと良い

日本リージョンでEC2インスタンスを起動してみる

AMIカタログで検索し、 `ami-****` で始まるのがid

削除の際、依存関係がある場合は適切な順番でTerraformは削除する

### AWS
AWS Skill Builder CloudQuest 感想まとめ記事

### Next.js
Learn Next.js 感想まとめ記事

## 3/2
### leetcode
https://leetcode.com/problems/exchange-seats/solutions/4437058/mysql-easy-solution-with-case-statement/
id を入れ替えてから id でorder by して元に戻すという画期的な解法

### 個人開発
authenticate() メソッドがエラーを吐く
(no verifier found in cache)
useEffectが2回マウントするのが原因の可能性がある
next.js でstrict mode をオフにする

```js
const nextConfig = {
  reactStrictMode: false,
};
```
やはりオフにすると出なくなる。authenticate()メソッドの使い方は間違っていない
https://docs.aws.amazon.com/ja_jp/sdk-for-javascript/v2/developer-guide/setting-credentials-node.html
AWS SDK for javascript
認証情報をロードする方法

https://chat.openai.com/share/2d284128-fb1c-49a9-8c7e-844cc359d1a1
AWS IAM roleを使って、DynamoDB read write 権限を
アプリケーションに付与する

https://docs.aws.amazon.com/ja_jp/sdk-for-javascript/v2/developer-guide/setting-credentials-node.html
javascript sdkで認証情報を設定する方法

### Terraform
Terraform configuration

blockの説明
terraform 必要なproviderの宣言
provider 特定のproviderの設定
resource EC2など、インフラのコンポーネントを定義する

`terraform fmt`
フォーマット
`terraform validate`
コンフィグが文法的に合っているかどうか

### AWS
VPC間の通信

CIDR
classless inter domain routing
8bit単位に区切ることにこだわらずにネットワークとサブネットを分ける表記

172.31.0.177
ピアリング接続を確立したら、ルーティングテーブルを設定する
さらに、接続先のセキュリティルールを変更する

### Next.js
記事執筆

## 3/1

### AOJ

https://cpprefjp.github.io/lang/cpp17/extension_to_aggregate_initialization.html
集成体初期化の拡張
コンストラクタを定義しなくても、初期化を簡単にできる
デフォルトコンストラクタ、コピーコンストラクタがないと簡単に宣言できず、
point.x = 1, point.y = 1 を全部書かないといけない

### 個人開発

Spotify Api の Next 版公式実装を解読する
https://github.com/spotify/spotify-web-api-ts-sdk
example_next を動かす
下記コマンドで spotify の sdk をインストールして npm run dev

```
npm install @spotify/web-api-ts-sdk
```

import エラーや、Invalid redirect_uri など多数のエラーが発生し
手動で直しきれず断念

example_react
これはそのまま動く。

なぜか useEffect の際に
"No verifier found in cache" が発生し、event のときに発生しないか
React が useEffect を 2 回呼ぶために発生している可能性がある
一度、2 回読み込む設定をいじって発生するかどうか調べる

以前使った方法で基本的に間違いは無し
サーバーサイドで検索などを行う可能性があるので、node のコードもチェックする

### Terraform

https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli
main.tf を配置し、terraform init で初期化
terraform.lock などはバージョンコントロール必須
次に init したときに同じ環境を再現するため
terraform apply で環境を構築し、 terraform destroy で破棄

asdf で aws-cli を再インストール

### AWS

高可用なウェブアプリ
Elastic Load Balancing
Auto Scaling
メトリクスデータに関しては cloudwatch と直接連携
ホストの追加・削除も直接ロードバランサと連携
CPU 使用率が 80%を超えたら、（cloudwatch による報告）
EC2 インスタンスを増やしてロードバランサーに追加

cloudfront
静的コンテンツの配信、キャッシュサーバー

failover
障害発生時の DB などの自動切り替えシステム

ロードバランサーヘルスモニタリング

セキュリティグループとは？
VPC 上で通信制御するファイアウォール機能

ターゲットグループでロードバランサーのヘルスチェックの設定ができる

Auto Scaling グループで、ネットワークから
別アベイラビリティーゾーンにサブネットを追加
詳細設定から希望するキャパシティ、最大キャパシティを増やすことで分散できる

### Next.js

partial pre-rendering
Suspence を使うことで、どの部分が dynamic なのか、境界を明示できる
通常、ウェブページは HTML を動的に生成するか、静的に生成するかが
url route にごとに決まっているが、Next.js では 1 ページの中に混在させられる
ショッピングカートなど、大部分は静的に生成したくとも、一部のカートなどは
動的に画面を生成したいことがある
